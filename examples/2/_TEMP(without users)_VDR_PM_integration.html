<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Manager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
        }
        .sidebar {
            width: 300px;
            padding: 20px;
            border-right: 1px solid #eee;
            height: auto;
            overflow-y: auto;
        }
        .main-content {
            flex-grow: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        input {
            padding: 8px;
            flex-grow: 1;
        }
        button {
            padding: 8px 16px;
            background: #0066cc;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:disabled {
            background-color: #0066cc52;
            cursor: initial;
        }
        ul {
            list-style: none;
            padding: 0;
        }
        li {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        li:hover {
            background-color: #f5f5f5;
        }
        .back-button {
            margin-bottom: 15px;
        }
        .view {
            display: none;
        }
        .active {
            display: block;
        }
        .ds-frame-container {
            position: absolute;
            right: 0;
            width: calc(100% - 340px);
            height: 100%;
        }
        h2 {
            margin-top: 0;
        }
        .task-view, .project-view {
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div id="projectListView" class="view active">
            <h2>Projects</h2>
            <div class="container">
                <input type="text" id="projectInput" placeholder="Enter project name">
                <button id="addProject" disabled onclick="addProject()">Add</button>
            </div>
            <ul id="projectList"></ul>
        </div>

        <div id="taskListView" class="view">
            <button class="back-button" onclick="showProjectList()">← Back to Projects</button>
            <h2 id="currentProjectName"></h2>
            <div class="container">
                <input type="text" id="taskInput" placeholder="Enter task name">
                <button id="addTask" onclick="addTask()">Add</button>
            </div>
            <ul id="taskList"></ul>
        </div>

        <div id="taskDetailView" class="view">
            <button class="back-button" onclick="showTaskList()">← Back to Tasks</button>
            <h2 id="currentTaskName"></h2>
        </div>
    </div>

    <div class="main-content">
        <iframe id="ds-frame" style="display: none;"></iframe>
        
        <div id="taskListFrameContainer" class="ds-frame-container" style="display: none;">
            <iframe id="task-list-frame" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
        
        <div id="taskDetailFrameContainer" class="ds-frame-container" style="display: none;">
            <iframe id="task-detail-frame" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>

    <script src="{{PORTAL_SRC}}/static/scripts/sdk/1.0.1/api.js"></script>
    <script>
        let docSpace;
        let taskListDocSpace;
        let taskDetailDocSpace;
        let currentRoomId = null;
        let currentFolderId = null;

        docSpace = DocSpace.SDK.initManager({
            frameId: "ds-frame",
            events: {
                onAppReady
            }
        });

        function onAppReady() {
            document.getElementById('addProject').removeAttribute('disabled');
            document.getElementById('ds-frame').style.display = 'none';
            
            setTimeout(async () => {
                try {
                    const rooms = await docSpace.getRooms({type: "VirtualDataRoom"});
                    populateProjectList(rooms.folders);
                } catch (error) {
                    console.error("Error fetching rooms:", error);
                }
            }, 500);
        }
        
        function populateProjectList(rooms) {
            const list = document.getElementById('projectList');
            list.innerHTML = '';
            
            rooms.forEach(room => {
                const li = document.createElement('li');
                li.textContent = room.title;
                li.onclick = () => openProject(room.id, room.title);
                list.appendChild(li);
            });
        }
        
        function addProject() {
            const input = document.getElementById('projectInput');
            const projectName = input.value.trim();
            
            if (projectName) {
                docSpace.createRoom(projectName, 8)
                    .then(room => {
                        const list = document.getElementById('projectList');
                        const li = document.createElement('li');
                        li.textContent = projectName;
                        li.onclick = () => openProject(room.id, room.title);
                        list.appendChild(li);
                        input.value = '';
                    })
                    .catch(error => {
                        console.error("Error creating room:", error);
                    });
            }
        }

        function openProject(roomId, roomTitle) {
            currentRoomId = roomId;
            document.getElementById('currentProjectName').textContent = roomTitle;
            
            document.getElementById('projectListView').classList.remove('active');
            document.getElementById('taskListView').classList.add('active');
            document.getElementById('taskDetailView').classList.remove('active');
            
            document.getElementById('taskListFrameContainer').style.display = 'block';
            document.getElementById('taskDetailFrameContainer').style.display = 'none';
            
            taskListDocSpace = DocSpace.SDK.initManager({
                frameId: "task-list-frame",
                showMenu: false,
                showTitle: false,
                showHeader: false,
                rootPath: "/rooms/shared/" + roomId,
                filter: {
                    folder: roomId,
                    filterType: 1
                },
                events: {
                    onAppReady: () => {
                        setTimeout(async () => {
                            try {
                                const folders = await taskListDocSpace.getFolders();
                                populateTaskList(folders);
                            } catch (error) {
                                console.error("Error fetching folders:", error);
                            }
                        }, 500);
                    }
                }
            });
            
        }
        
        function populateTaskList(folders) {
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            
            folders.forEach(folder => {
                const li = document.createElement('li');
                li.textContent = folder.title;
                li.onclick = () => openTask(folder.id, folder.title);
                list.appendChild(li);
            });
        }
        
        function addTask() {
            const input = document.getElementById('taskInput');
            const taskName = input.value.trim();
            
            if (taskName && currentRoomId) {
                taskListDocSpace.createFolder(currentRoomId, taskName)
                    .then(folder => {
                        const list = document.getElementById('taskList');
                        const li = document.createElement('li');
                        li.textContent = taskName;
                        li.onclick = () => openTask(folder.id, folder.title);
                        list.appendChild(li);
                        input.value = '';
                    })
                    .catch(error => {
                        console.error("Error creating folder:", error);
                    });
            }
        }
        
        function openTask(folderId, folderTitle) {
            currentFolderId = folderId;
            document.getElementById('currentTaskName').textContent = folderTitle;
            
            document.getElementById('projectListView').classList.remove('active');
            document.getElementById('taskListView').classList.remove('active');
            document.getElementById('taskDetailView').classList.add('active');
            
            document.getElementById('taskListFrameContainer').style.display = 'none';
            document.getElementById('taskDetailFrameContainer').style.display = 'block';
            
            taskDetailDocSpace = DocSpace.SDK.initManager({
                frameId: "task-detail-frame",
                showMenu: false,
                showTitle: false,
                showHeader: false,
                rootPath: "/rooms/shared/" + currentRoomId,
                filter: {
                    folder: folderId,
                }
            });
            
        }
        
        function showProjectList() {
            const list = document.getElementById('taskList');
            list.innerHTML = '';

            document.getElementById('projectListView').classList.add('active');
            document.getElementById('taskListView').classList.remove('active');
            document.getElementById('taskDetailView').classList.remove('active');
            
            document.getElementById('taskListFrameContainer').style.display = 'none';
            document.getElementById('taskDetailFrameContainer').style.display = 'none';
        }
        
        function showTaskList() {
            document.getElementById('projectListView').classList.remove('active');
            document.getElementById('taskListView').classList.add('active');
            document.getElementById('taskDetailView').classList.remove('active');
            
            document.getElementById('taskListFrameContainer').style.display = 'block';
            document.getElementById('taskDetailFrameContainer').style.display = 'none';
        }

        document.getElementById('projectInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addProject();
            }
        });
        
        document.getElementById('taskInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTask();
            }
        });
    </script>
</body>
</html>
